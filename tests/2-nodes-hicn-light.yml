version: "3"
services:
  client:
    container_name: ${TEST_LIGHT}-client
    command:
      - |
        if [ -d /workspace/build-dev ]; then
          sudo ninja -C /workspace/build-dev install
        fi

        sudo ip addr add 192.168.1.1/24 brd + dev eth0
        tee -a /tmp/hicn-light.conf <<EOF
        add listener udp local0 192.168.1.1 9199 eth0
        add connection udp conn0 192.168.1.1 9199 192.168.1.2 9199
        add route conn0 b002::/64 1
        EOF

        rm -f ${FORWARDER_LOG_PATH}

        sudo hicn-light-daemon \
          --daemon \
          --log-file ${FORWARDER_LOG_PATH} \
          --config /tmp/hicn-light.conf

        tail -f /dev/null

  server:
    container_name: ${TEST_LIGHT}-server
    command:
      - |
        if [ -d /workspace/build-dev ]; then
          sudo ninja -C /workspace/build-dev install
        fi

        sudo ip addr add 192.168.1.2/24 dev eth0

        tee -a /tmp/hicn-light.conf <<EOF
        add listener udp local0 192.168.1.2 9199 eth0
        add connection udp conn0 192.168.1.2 9199 192.168.1.1 9199
        add route conn0 b002::/64 1
        EOF

        rm -f ${FORWARDER_LOG_PATH}

        sudo hicn-light-daemon \
          --daemon \
          --log-file ${FORWARDER_LOG_PATH} \
          --config /tmp/hicn-light.conf --capacity 0

        sleep 4

        hiperf -q -z hicnlight_module -S -R -B 4000kbps ${RTC_PRODUCER} -P 2 &
        hiperf -q -z hicnlight_module -S ${RAAQM_PRODUCER}/128 &
        hiperf -q -z hicnlight_module -S ${RAAQM_PRODUCER_NEW}/128 &
        hicn-ping-server -z hicnlight_module -s 0 -n ${PING_PRODUCER}/128 &

        tail -f /dev/null
